pipeline {
    agent any
    environment {
        REGION = 'ap-southeast-1' // Set your desired AWS region
        CLUSTER_NAME = 'huan-tetris-cluster' // Set your EKS cluster name
    }
    stages {
        stage('Checkout') {
	  steps {
        deleteDir() // Clean workspace before checkout
		checkout scm
	  }
	}

        stage('Init EKS Infra') {
            steps {
                // Bind AWS credentials stored in Jenkins (adjust credentialsId as needed)
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'aws-access-creds'
                ]]) {
                    dir('terraform') {
                        // ensure script is executable and run the infra init script
                        aws eks update-kubeconfig --name="${CLUSTER_NAME}" --region="${REGION}"
                        sh 'chmod +x cleanup.sh'
                        sh './cleanup.sh'
                    }
                }
            }
        }
    }

    post {
        failure {
            echo 'EKS infra cleanup failed.'
        }
        success {
            echo 'EKS infra cleanup completed.'
        }
    }
}