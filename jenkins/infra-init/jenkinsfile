pipeline {
    agent any

    stages {
        stage('Checkout') {
	  steps {
        deleteDir() // Clean workspace before checkout
		checkout scm
	  }
	}

        stage('Init EKS Infra') {
            steps {
                // Bind AWS credentials stored in Jenkins (adjust credentialsId as needed)
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'aws-access-creds'
                ]]) {
                    dir('terraform') {
                        // ensure script is executable and run the infra init script
                        sh 'chmod +x infra-init.sh'
                        sh './infra-init.sh'
                    }
                }
            }
        }
    }

    post {
        failure {
            echo 'EKS infra init failed.'
        }
        success {
            echo 'EKS infra init completed.'
        }
    }
}